<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ToDo Liste</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <h1>Aufgabenliste Uni</h1>
  <form id="newTaskForm" class="new-task" onsubmit="return false;">
    <input id="taskInput" type="text" placeholder="Neue Aufgabe (Titel)" aria-label="Neue Aufgabe" required />
    <input id="startDate" type="date" aria-label="Startdatum" />
    <input id="endDate" type="date" aria-label="Enddatum" />
    <button id="addBtn">Hinzufügen</button>
  </form>
  <div class="subtask-creator">
    <input id="subtaskInput" type="text" placeholder="Unteraufgabe (optional)" />
    <input id="subStart" type="date" />
    <input id="subEnd" type="date" />
    <button id="addSubBtn">Unteraufgabe hinzufügen</button>
    <ul id="pendingSubtasks" class="pending-subtasks"></ul>
  </div>
  <ul id="taskList" aria-live="polite"></ul>
  <div class="count"><span id="remaining">0</span> Aufgaben übrig</div>

  <script>
    const input = document.getElementById('taskInput');
    const addBtn = document.getElementById('addBtn');
    const list = document.getElementById('taskList');
    const remaining = document.getElementById('remaining');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const subtaskInput = document.getElementById('subtaskInput');
    const addSubBtn = document.getElementById('addSubBtn');
    const pendingSubtasks = document.getElementById('pendingSubtasks');

    // temporary list of subtasks while creating a task
    let tempSubtasks = [];

    // Color palette for tasks
    const colorPalette = [
      { bg: '#FFE8E8', border: '#E74C3C' },
      { bg: '#E8F5FF', border: '#3498DB' },
      { bg: '#E8FFE8', border: '#27AE60' },
      { bg: '#FFF4E8', border: '#F39C12' },
      { bg: '#F4E8FF', border: '#8E44AD' },
      { bg: '#E8FFFF', border: '#1ABC9C' },
      { bg: '#FFFFE8', border: '#F1C40F' },
      { bg: '#FFE8F4', border: '#E91E63' }
    ];

    function getColorForTask(taskIndex) {
      return colorPalette[taskIndex % colorPalette.length];
    }

    function loadTasks(){
      try{
        return JSON.parse(localStorage.getItem('tasks') || '[]');
      }catch(e){
        return [];
      }
    }

    function saveTasks(tasks){
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }

    function showSubtaskModal(taskIdx, tasks, render) {
      // Create modal overlay
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      modalContent.innerHTML = `
        <h3>Unteraufgabe hinzufügen</h3>
        <input type="text" id="modalSubtaskText" placeholder="Unteraufgabe" />
        <input type="date" id="modalSubStart" />
        <input type="date" id="modalSubEnd" />
        <div class="modal-actions">
          <button id="modalAddBtn">Hinzufügen</button>
          <button id="modalCancelBtn">Abbrechen</button>
        </div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      const textInput = document.getElementById('modalSubtaskText');
      const startInput = document.getElementById('modalSubStart');
      const endInput = document.getElementById('modalSubEnd');
      const addBtn = document.getElementById('modalAddBtn');
      const cancelBtn = document.getElementById('modalCancelBtn');
      
      function closeModal() {
        modal.remove();
      }
      
      addBtn.addEventListener('click', () => {
        const text = textInput.value.trim();
        if(!text) return;
        
        if(!Array.isArray(tasks[taskIdx].subtasks)) {
          tasks[taskIdx].subtasks = [];
        }
        
        tasks[taskIdx].subtasks.push({
          text: text,
          done: false,
          startDate: startInput.value || null,
          endDate: endInput.value || null
        });
        
        saveTasks(tasks);
        closeModal();
        render();
      });
      
      cancelBtn.addEventListener('click', closeModal);
      textInput.focus();
    }

    function render(){
      const tasks = loadTasks();
      // Sort tasks by endDate (earliest first), undefined dates go to the end
      tasks.sort((a, b) => {
        const aDate = a.endDate ? new Date(a.endDate).getTime() : Infinity;
        const bDate = b.endDate ? new Date(b.endDate).getTime() : Infinity;
        return aDate - bDate;
      });
      list.innerHTML = '';
      tasks.forEach((t, idx) => {
        const li = document.createElement('li');
        li.className = 'task-item ' + (t.done ? 'completed' : '');
        
        // Check if endDate is less than 24h away
        if(t.endDate && !t.done) {
          const endTime = new Date(t.endDate).getTime();
          const now = Date.now();
          const hoursRemaining = (endTime - now) / (1000 * 60 * 60);
          if(hoursRemaining < 24 && hoursRemaining > 0) {
            li.classList.add('urgent');
          }
        }
        
        // apply dynamic task color
        const color = getColorForTask(idx);
        li.style.backgroundColor = color.bg;
        li.style.borderLeft = '6px solid ' + color.border;

        const left = document.createElement('div');
        left.className = 'left-col';

        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = !!t.done;
        chk.addEventListener('change', () => {
          tasks[idx].done = chk.checked;
          saveTasks(tasks);
          render();
        });

        left.appendChild(chk);

        const content = document.createElement('div');
        content.className = 'content-col';

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = t.text;

        const meta = document.createElement('div');
        meta.className = 'meta';
        const start = t.startDate ? new Date(t.startDate).toLocaleDateString() : '-';
        const end = t.endDate ? new Date(t.endDate).toLocaleDateString() : '-';
        meta.textContent = `${start} → ${end}`;

        content.appendChild(title);
        content.appendChild(meta);

        // subtasks
        if(Array.isArray(t.subtasks) && t.subtasks.length){
          const subUl = document.createElement('ul');
          subUl.className = 'subtasks';
          t.subtasks.forEach((s, sidx) => {
            const sli = document.createElement('li');
            sli.className = s.done ? 'sub-completed' : '';

            const schild = document.createElement('input');
            schild.type = 'checkbox';
            schild.checked = !!s.done;
            schild.addEventListener('change', () => {
              t.subtasks[sidx].done = schild.checked;
              saveTasks(tasks);
              render();
            });

            const stext = document.createElement('span');
            stext.textContent = s.text + (s.startDate || s.endDate ? ` (${s.startDate||'-'}→${s.endDate||'-'})` : '');

            const sdel = document.createElement('button');
            sdel.textContent = 'Löschen';
            sdel.addEventListener('click', () => {
              t.subtasks.splice(sidx,1);
              saveTasks(tasks);
              render();
            });

            sli.appendChild(schild);
            sli.appendChild(stext);
            sli.appendChild(sdel);
            subUl.appendChild(sli);
          });
          content.appendChild(subUl);
        }

        const actions = document.createElement('div');
        actions.className = 'actions';
        
        const addSubBtn = document.createElement('button');
        addSubBtn.textContent = '+ Unteraufgabe';
        addSubBtn.addEventListener('click', () => {
          showSubtaskModal(idx, tasks, render);
        });
        
        const del = document.createElement('button');
        del.textContent = 'Löschen';
        del.addEventListener('click', () => {
          tasks.splice(idx,1);
          saveTasks(tasks);
          render();
        });
        actions.appendChild(addSubBtn);
        actions.appendChild(del);

        li.appendChild(left);
        li.appendChild(content);
        li.appendChild(actions);
        list.appendChild(li);
      });
      const remainingCount = tasks.filter(t=>!t.done).length;
      remaining.textContent = remainingCount;
    }

    function addTask(){
      const text = input.value;
      const startDate = startDateInput.value || null;
      const endDate = endDateInput.value || null;
      if(!text || !text.trim()) return;
      const tasks = loadTasks();
      const task = {
        text: text.trim(),
        startDate,
        endDate,
        done: false,
        createdAt: Date.now(),
        subtasks: tempSubtasks.slice()
      };
      tasks.unshift(task);
      saveTasks(tasks);
      // reset form
      input.value = '';
      startDateInput.value = '';
      endDateInput.value = '';
      tempSubtasks = [];
      pendingSubtasks.innerHTML = '';
      input.focus();
      render();
    }

    addBtn.addEventListener('click', () => { addTask(); });
    input.addEventListener('keydown', (e) => { if(e.key === 'Enter'){ addTask(); } });

    addSubBtn.addEventListener('click', () => {
      const st = subtaskInput.value;
      const sStart = document.getElementById('subStart').value || null;
      const sEnd = document.getElementById('subEnd').value || null;
      if(!st || !st.trim()) return;
      const sub = { text: st.trim(), done: false, startDate: sStart, endDate: sEnd };
      tempSubtasks.push(sub);
      // render pending list
      const li = document.createElement('li');
      li.textContent = sub.text + (sub.startDate||sub.endDate ? ` (${sub.startDate||'-'}→${sub.endDate||'-'})` : '');
      const rem = document.createElement('button');
      rem.textContent = 'Entfernen';
      rem.addEventListener('click', () => {
        const i = Array.from(pendingSubtasks.children).indexOf(li);
        if(i>-1){ tempSubtasks.splice(i,1); li.remove(); }
      });
      li.appendChild(rem);
      pendingSubtasks.appendChild(li);
      subtaskInput.value = '';
      document.getElementById('subStart').value = '';
      document.getElementById('subEnd').value = '';
    });

    // initial render
    render();
  </script>
</body>
</html>

